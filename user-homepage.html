<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Kullanıcı Anasayfası - Nova Dev</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/x-icon" href="./images/study.png">
    <style>


#studentTaskPopup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 999;
}
#studentTaskPopup .popup-content {
    background-color: white;
    padding: 20px;
    border-radius: 12px;
    max-width: 800px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
}
#studentTaskPopup .close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background-color: #f44336;
    color: white;
    border: none;
    padding: 6px 10px;
    border-radius: 5px;
    cursor: pointer;
}

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: #f2f2f2;
            background-image: url('./images/homepage-bg.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        header {
            background-color: #007acc;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: white;
            color: #007acc;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        .logout-btn:hover {
            background-color: #f44336;
            color: white;
        }
        .content {
            max-width: 1000px;
            margin: 100px auto;
            padding: 30px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            text-align: center;
        }
        .content h2 {
            color: #007acc;
        }
        .cards {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between; 
            margin-top: 30px;
            gap: 20px; 
        }
        .card {
            flex: 1 1 30%; 
            min-width: 250px; 
            max-width: 300px; 
            background-color: #f4f4f4;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            text-align: center; 
        }
        .card:hover {
            transform: scale(1.03);
        }
        .popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }
        .popup-content {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #007acc;
            color: white;
        }
        .close-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 5px;
            float: right;
            cursor: pointer;
        }
        #statusMessage {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4caf50;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            display: none;
            z-index: 1100;
            font-weight: bold;
        }
        #statusMessage.error {
            background-color: #f44336;
        }
        
        #taskDenemeAnaliziPopup .popup-content { 
            max-width: 600px; 
        }
        #denemeInputForm div {
            margin-bottom: 10px;
        }
        #denemeInputForm label {
            display: inline-block;
            width: 120px;
        }
        #denemeInputForm input[type="text"],
        #denemeInputForm input[type="number"] {
            width: calc(100% - 130px);
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #denemeInputForm button, #taskDenemeAnaliziPopup .popup-content > button { 
            background-color: #007acc;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        #denemeInputForm button:hover, #taskDenemeAnaliziPopup .popup-content > button:hover { 
            background-color: #005fa3;
        }
        #denemeSubjectListContainer ul {
            list-style-type: none;
            padding: 0;
        }
        #denemeSubjectListContainer li {
            background-color: #f9f9f9;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            border: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #denemeSubjectListContainer li button {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
       
        #generalDenemeAnaliziPopup .popup-content {
            max-width: 500px;
        }
        #generalDenemeForm div {
            margin-bottom: 8px; display: flex; align-items: center;
        }
        #generalDenemeForm label {
            flex-basis: 100px; margin-right: 10px;
        }
        #generalDenemeForm input[type="number"] {
            flex-grow: 1; padding: 6px; border: 1px solid #ccc; border-radius: 4px; width: 60px; margin-right: 5px;
        }
        #generalDenemeForm button {
            background-color: #007acc; color: white; border: none; padding: 10px 15px;
            border-radius: 5px; cursor: pointer; margin-top: 15px; width: 100%;
        }
         #generalDenemeForm button:hover {
            background-color: #005fa3;
        }


    </style>
</head>
<body>
    <header>
        <h1>👋 Hoşgeldiniz Nova Dev Kullanıcısı</h1>
        <button class="logout-btn" onclick="window.location.href='index.html'">Çıkış Yap</button>
    </header>

    <div class="content">
        <h2>Profil Sayfanız</h2>
        <p>Sisteme giriş yaptınız. Burada size özel içerikler yer alacaktır.</p>

        <div class="cards">
            <div class="card" onclick="openPopup()">🆕 Yeni Dönem Ders Seçimi</div>
            <div class="card">📝 Ders Notlarınız</div>
            <div class="card" onclick="openSelectedCoursesPopup()">📘 Seçtiğiniz Dersler</div>
            <div class="card">📅 Duyurular</div>
            <div class="card">💬 Hocaya Mesaj Atın</div>
            <div class="card" onclick="openGeneralDenemeAnalizi()">📊 Genel Deneme Analizi</div> 
        </div>

        <div class="content">
            <h2>🎯 Size Atanan Görevler</h2>
            <div class="card" onclick="openTaskPopup()" style="max-width:none; width:100%;">📌 Görevleri Göster</div>
        </div>
        
        <div class="popup" id="studentTaskPopup">
            <div class="popup-content">
                <button class="close-btn" onclick="closeTaskPopup()">X</button>
                <h3>📋 Size Atanan Görevler</h3>
                <ul id="studentTaskList" style="list-style: none; padding: 0; margin-top: 20px;"></ul>
            </div>
        </div>
    </div>

    <div class="popup" id="popup">
        <div class="popup-content">
            <button class="close-btn" onclick="closePopup()">X</button>
            <h3>Mevcut Dersler</h3>
            <div id="courseTable"></div>
        </div>
    </div>

    <div class="popup" id="selectedPopup">
        <div class="popup-content">
            <button class="close-btn" onclick="closeSelectedCoursesPopup()">X</button>
            <h3>Seçtiğiniz Dersler</h3>
            <div id="selectedCoursesTable"></div>
        </div>
    </div>

    <div id="statusMessage"></div>

    
    <div id="taskDenemeAnaliziPopup" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div class="popup-content" style="background:#fff; padding:20px; border-radius:10px; width:90%; max-width:600px; position:relative;">
            <button class="close-btn" onclick="closeTaskDenemeAnaliziPopup()">X</button>
            <h2 id="taskDenemeAnaliziPopupTitle">Deneme Analizi</h2>
            <input type="hidden" id="currentDenemeTaskId">

            <div id="denemeInputForm">
                <h3>Yeni Ders Ekle:</h3>
                <div><label for="newDenemeSubjectName">Ders Adı:</label><input id="newDenemeSubjectName" type="text"></div>
                <div><label for="newDenemeCorrect">Doğru Sayısı:</label><input id="newDenemeCorrect" type="number" min="0" value="0"></div>
                <div><label for="newDenemeIncorrect">Yanlış Sayısı:</label><input id="newDenemeIncorrect" type="number" min="0" value="0"></div>
                <div><label for="newDenemeBlank">Boş Sayısı:</label><input id="newDenemeBlank" type="number" min="0" value="0"></div>
                <button onclick="addSubjectToDenemeList()">Bu Dersi Listeye Ekle</button>
            </div>

            <div id="denemeSubjectListContainer" style="margin-top:20px; margin-bottom:20px;">
                
            </div>
            
            <button onclick="saveAndAnalyzeTaskDenemeResults()" style="margin-bottom:20px; width:100%;">Tüm Sonuçları Kaydet ve Analiz Et</button>
            
            <canvas id="taskNetChart" style="margin-top:20px;"></canvas> 
        </div>
    </div>

    
    <div id="generalDenemeAnaliziPopup" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div class="popup-content" style="background:#fff; padding:20px; border-radius:10px; width:90%; max-width:500px; position:relative;">
            <button class="close-btn" onclick="closeGeneralDenemeAnalizi()">X</button>
    
          <h2>Genel Deneme Analizi</h2>
          <form id="generalDenemeForm">
            <div>Ders | Doğru | Yanlış | Boş</div>
            <div><label>Türkçe:</label> <input name="turkce_d" type="number" placeholder="D" value="0" required> <input name="turkce_y" type="number" placeholder="Y" value="0" required> <input name="turkce_b" type="number" placeholder="B" value="0" required></div>
            <div><label>Matematik:</label> <input name="mat_d" type="number" placeholder="D" value="0" required> <input name="mat_y" type="number" placeholder="Y" value="0" required> <input name="mat_b" type="number" placeholder="B" value="0" required></div>
            <div><label>Fen:</label> <input name="fen_d" type="number" placeholder="D" value="0" required> <input name="fen_y" type="number" placeholder="Y" value="0" required> <input name="fen_b" type="number" placeholder="B" value="0" required></div>
            <div><label>Sosyal:</label> <input name="sos_d" type="number" placeholder="D" value="0" required> <input name="sos_y" type="number" placeholder="Y" value="0" required> <input name="sos_b" type="number" placeholder="B" value="0" required></div>
            <div><label>İngilizce:</label> <input name="ing_d" type="number" placeholder="D" value="0" required> <input name="ing_y" type="number" placeholder="Y" value="0" required> <input name="ing_b" type="number" placeholder="B" value="0" required></div>
            <br>
            <button type="submit">Netleri Hesapla ve Grafiği Göster</button>
          </form>
          <canvas id="generalNetChart" style="margin-top:20px;"></canvas>
        </div>
      </div>

  
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
    <script>
        function openPopup() {
            fetch('get-courses.php')
                .then(res => res.text())
                .then(data => {
                    document.getElementById('courseTable').innerHTML = data;
                    document.getElementById('popup').style.display = 'flex';
                });
        }

        function closePopup() {
            document.getElementById('popup').style.display = 'none';
        }

        function openSelectedCoursesPopup() {
            fetch('get-selected-courses.php')
                .then(res => res.text())
                .then(data => {
                    document.getElementById('selectedCoursesTable').innerHTML = data;
                    document.getElementById('selectedPopup').style.display = 'flex';
                });
        }

        function closeSelectedCoursesPopup() {
            document.getElementById('selectedPopup').style.display = 'none';
        }

        function selectCourse(course) {
            const formData = new FormData();
            formData.append('courseCode', course.course_code);
            formData.append('courseName', course.course_name);
            formData.append('courseTeacher', course.course_teacher);
            formData.append('courseDept', course.course_department);

            fetch('select-course.php', {
                method: 'POST',
                body: formData
            })
            .then(res => res.text())
            .then(message => {
                const status = document.getElementById("statusMessage");
                status.textContent = message;
                status.className = message.includes("zaten") ? 'error' : '';
                status.style.display = "block";

                setTimeout(() => {
                    status.style.display = "none";
                }, 3000);
            })
            .catch(error => {
                const status = document.getElementById("statusMessage");
                status.textContent = "Bir hata oluştu: " + error;
                status.className = 'error';
                status.style.display = "block";
                setTimeout(() => {
                    status.style.display = "none";
                }, 3000);
            });
        }

        function deleteCourse(id) {
            fetch('delete-course.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'id=' + id
            })
            .then(res => res.text())
            .then(message => {
                const status = document.getElementById("statusMessage");
                status.textContent = message;
                status.className = '';
                status.style.display = "block";
                setTimeout(() => {
                    status.style.display = "none";
                    openSelectedCoursesPopup(); 
                }, 2000);
            });
        }

        const studentId = 2355022; 

           function openTaskPopup() {
        loadStudentTasks(); 
        document.getElementById("studentTaskPopup").style.display = "flex";
    }

    function closeTaskPopup() {
        document.getElementById("studentTaskPopup").style.display = "none";
    }

            function loadStudentTasks() {
        const listContainer = document.getElementById("studentTaskList");
        listContainer.innerHTML = "<li>Görevler yükleniyor...</li>"; 
        fetch('get_student_tasks.php') 
            .then(res => {
                if (!res.ok) { 
                   throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
             })
            .then(data => {
                listContainer.innerHTML = ""; 

                if (data.error) {
                    listContainer.innerHTML = `<li>Hata: ${data.error}</li>`;
                    console.error("Görevleri alırken sunucu hatası:", data.error);
                    return;
                }

                if (!data.tasks || data.tasks.length === 0) {
                    listContainer.innerHTML = "<li>Henüz size atanmış bir görev bulunmamaktadır.</li>";
                    return;
                }

                
                const tasksByGoal = data.tasks.reduce((acc, task) => {
                    const goalId = task.goal_id;
                    if (!acc[goalId]) {
                        
                        acc[goalId] = { goalTitle: task.goal_title, tasks: [] };
                    }
                    acc[goalId].tasks.push(task);
                    return acc;
                }, {});

                
                for (const goalId in tasksByGoal) {
                    const goalData = tasksByGoal[goalId];
                    const goalHeader = document.createElement('h4');
                    goalHeader.textContent = `🎯 Hedef: ${goalData.goalTitle}`;
                    goalHeader.style.marginTop = '15px';
                    goalHeader.style.marginBottom = '10px';
                    goalHeader.style.borderBottom = '1px solid #eee';
                    goalHeader.style.paddingBottom = '5px';
                    listContainer.appendChild(goalHeader);

                    goalData.tasks.forEach(task => {
                        const li = document.createElement("li");
                        const isDone = task.is_done;

                        const taskBox = document.createElement('div');
                        taskBox.className = 'task-box';
                        taskBox.dataset.taskId = task.task_id; 
                        taskBox.style.cssText = `
                            border: 1px solid #ccc;
                            margin-bottom: 10px;
                            padding: 12px;
                            border-radius: 6px;
                            background-color: ${isDone ? '#e9f5e9' : '#fdfdfd'}; /* Tamamlananlar için farklı arka plan */
                            opacity: ${isDone ? 0.7 : 1}; /* Tamamlananlar için soluk görünüm */
                            transition: background-color 0.3s ease, opacity 0.3s ease;
                        `;

                        
                        taskBox.innerHTML = `
                            <strong class="task-title" style="font-size: 1.1em; text-decoration: ${isDone ? 'line-through' : 'none'}">${task.task_order}. ${task.task_title}</strong><br>
                            ${task.task_description ? `<small class="task-desc" style="display: block; margin: 5px 0; text-decoration: ${isDone ? 'line-through' : 'none'}">${task.task_description}</small>` : ''}
                            <div class="task-details" style="font-size: 0.9em; color: #555; margin-top: 8px; text-decoration: ${isDone ? 'line-through' : 'none'}">
                                ${task.subject ? `<span><strong>Ders:</strong> ${task.subject}</span>` : ''}
                                ${task.topic ? `<span style="margin-left: 10px;"><strong>Konu:</strong> ${task.topic}</span>` : ''}
                                ${task.question_count ? `<span style="margin-left: 10px;"><strong>Soru:</strong> ${task.question_count}</span>` : ''}
                                ${task.task_date ? `<span style="margin-left: 10px;"><strong>Tarih:</strong> ${task.task_date_formatted}</span>` : ''}
                            </div>
                            <button class="toggle-done-btn" onclick="toggleDone(${task.task_id}, this)" style="margin-top: 10px; padding: 5px 10px; cursor: pointer; border-radius: 4px; border: 1px solid ${isDone ? '#f44336' : '#4CAF50'}; background-color: ${isDone ? '#fff' : '#4CAF50'}; color: ${isDone ? '#f44336' : '#fff'};">
                                ${isDone ? '↩️ Geri Al' : '✔️ Tamamladım'}
                            </button>
                        `;
                  
                        li.appendChild(taskBox);
                        listContainer.appendChild(li);
                    });
                }
            })
            .catch(err => {
                listContainer.innerHTML = `<li>Görevler yüklenirken bir hata oluştu. Lütfen tekrar deneyin.</li>`;
                console.error("Görevleri fetch ederken hata:", err);
            });
    }

        function toggleDone(taskId, btn) {
        const taskBox = btn.closest(".task-box");
      
        const isCurrentlyDone = btn.textContent.includes('Geri Al');
        const newStatus = isCurrentlyDone ? 0 : 1; 
        
        btn.disabled = true;
        btn.textContent = 'İşleniyor...';

        fetch('update_student_task_status.php', { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            
            body: JSON.stringify({ task_id: taskId, is_completed: newStatus })
        })
        .then(res => {
             if (!res.ok) { throw new Error(`HTTP error! status: ${res.status}`); }
             return res.json()
        })
        .then(data => {
            if (data.success) {
                
                const isNowDone = newStatus === 1;
                taskBox.style.backgroundColor = isNowDone ? '#e9f5e9' : '#fdfdfd';
                taskBox.style.opacity = isNowDone ? 0.7 : 1;
                taskBox.querySelectorAll('.task-title, .task-desc, .task-details span').forEach(el => {
                    el.style.textDecoration = isNowDone ? 'line-through' : 'none';
                });
                btn.textContent = isNowDone ? '↩️ Geri Al' : '✔️ Tamamladım';
                 btn.style.borderColor = isNowDone ? '#f44336' : '#4CAF50';
                 btn.style.backgroundColor = isNowDone ? '#fff' : '#4CAF50';
                 btn.style.color = isNowDone ? '#f44336' : '#fff';

            } else {
                alert("Görev durumu güncellenemedi: " + (data.message || 'Bilinmeyen hata'));
                 
                 btn.textContent = isCurrentlyDone ? '↩️ Geri Al' : '✔️ Tamamladım';
            }
        })
        .catch((error) => {
            console.error("Toggle Done Error:", error);
            alert("Görev durumu güncellenirken bir ağ hatası oluştu.");
           
            btn.textContent = isCurrentlyDone ? '↩️ Geri Al' : '✔️ Tamamladım';
        })
        .finally(() => {
          
            btn.disabled = false;
        });
    }

       
        let currentExamTaskSubjects = []; 
        window.taskDenemeNetChartInstance = null; 

        function openTaskDenemeAnaliziPopupForTask(taskId, taskTitle) {
            document.getElementById('taskDenemeAnaliziPopupTitle').textContent = `Deneme Analizi: ${taskTitle}`;
            document.getElementById('currentDenemeTaskId').value = taskId;
            currentExamTaskSubjects = []; 
            document.getElementById('denemeSubjectListContainer').innerHTML = ''; 
            
            if (window.taskDenemeNetChartInstance) {
                window.taskDenemeNetChartInstance.destroy();
            }
            
            fetchAndDisplayExamResults(taskId);
            document.getElementById('taskDenemeAnaliziPopup').style.display = 'flex'; 
        }
        
        function fetchAndDisplayExamResults(taskId) {
            fetch(`get_trial_exam_subject_results.php?task_id=${taskId}`)
                .then(res => res.json())
                .then(data => {
                    currentExamTaskSubjects = data.map(s => ({
                        name: s.subject_name,
                        correct: s.correct_count,
                        incorrect: s.incorrect_count,
                        blank: s.blank_count,
                        net: parseFloat(s.net_score) 
                    }));
                    renderDenemeSubjectList();
                    generateTaskDenemeChart(); 
                })
                .catch(err => {
                    console.error("Error fetching exam results:", err);
                    currentExamTaskSubjects = []; 
                    renderDenemeSubjectList(); 
                    generateTaskDenemeChart(); 
                });
        }


        function closeTaskDenemeAnaliziPopup() { 
            document.getElementById('taskDenemeAnaliziPopup').style.display = 'none'; 
        }

        function addSubjectToDenemeList() {
            const name = document.getElementById('newDenemeSubjectName').value.trim();
            const correct = parseInt(document.getElementById('newDenemeCorrect').value) || 0;
            const incorrect = parseInt(document.getElementById('newDenemeIncorrect').value) || 0;
            const blank = parseInt(document.getElementById('newDenemeBlank').value) || 0;

            if (!name) {
                alert("Lütfen ders adını girin.");
                return;
            }

            currentExamTaskSubjects.push({ name, correct, incorrect, blank, net: (correct - incorrect / 4.0) });
            renderDenemeSubjectList();
            generateTaskDenemeChart(); 

            document.getElementById('newDenemeSubjectName').value = '';
            document.getElementById('newDenemeCorrect').value = '0';
            document.getElementById('newDenemeIncorrect').value = '0';
            document.getElementById('newDenemeBlank').value = '0';
            document.getElementById('newDenemeSubjectName').focus();
        }

        function renderDenemeSubjectList() {
            const listContainer = document.getElementById('denemeSubjectListContainer');
            listContainer.innerHTML = '<h4>Eklenen Dersler:</h4>';
            if (currentExamTaskSubjects.length === 0) {
                listContainer.innerHTML += '<p>Henüz ders eklenmedi.</p>';
                return;
            }
            const ul = document.createElement('ul');
            currentExamTaskSubjects.forEach((sub, index) => {
                const net = (sub.correct - sub.incorrect / 4.0).toFixed(2);
                const li = document.createElement('li');
                li.textContent = `${sub.name}: D:${sub.correct}, Y:${sub.incorrect}, B:${sub.blank}, Net: ${net}`;
                
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Kaldır';
                removeBtn.onclick = () => {
                    currentExamTaskSubjects.splice(index, 1);
                    renderDenemeSubjectList();
                    generateTaskDenemeChart(); 
                };
                li.appendChild(removeBtn);
                ul.appendChild(li);
            });
            listContainer.appendChild(ul);
        }

        function saveAndAnalyzeTaskDenemeResults() { 
            const taskId = document.getElementById('currentDenemeTaskId').value;
            if (currentExamTaskSubjects.length === 0) {
                alert("Kaydedilecek ders bulunmamaktadır. Lütfen önce ders ekleyin.");
                return;
            }

            const subjectsToSave = currentExamTaskSubjects.map(s => ({
                name: s.name,
                correct: s.correct,
                incorrect: s.incorrect,
                blank: s.blank
            }));

            fetch('save_trial_exam_results.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ task_id: taskId, subjects: subjectsToSave })
            })
            .then(res => res.json())
            .then(response => {
                if (response.success) {
                    alert("Deneme sonuçları başarıyla kaydedildi!");
                    fetchAndDisplayExamResults(taskId); 
                } else {
                    alert("Hata: " + (response.message || response.error || "Bilinmeyen bir hata oluştu."));
                }
            })
            .catch(err => {
                console.error("Error saving exam results:", err);
                alert("Deneme sonuçları kaydedilirken bir hata oluştu.");
            });
        }

        function generateTaskDenemeChart() {
            const ctx = document.getElementById("taskNetChart").getContext("2d"); 
            if (window.taskDenemeNetChartInstance) { 
                window.taskDenemeNetChartInstance.destroy(); 
            }

            if (currentExamTaskSubjects.length === 0) {
                return;
            }

            const labels = currentExamTaskSubjects.map(s => s.name);
            const netScores = currentExamTaskSubjects.map(s => 
                typeof s.net !== 'undefined' ? parseFloat(s.net) : parseFloat((s.correct - s.incorrect / 4.0).toFixed(2))
            );
            
            window.taskDenemeNetChartInstance = new Chart(ctx, { 
                type: "bar", 
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ders Bazlı Netler',
                        data: netScores,
                        backgroundColor: [
                            "#f44336", "#2196F3", "#4CAF50", "#FF9800", "#9C27B0",
                            "#3F51B5", "#00BCD4", "#8BC34A", "#FFEB3B", "#795548",
                            "#FF5722", "#607D8B" 
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Ders Bazlı Net Dağılımı' }
                    },
                    scales: {
                        y: {
                            beginAtZero: false 
                        }
                    }
                }
            });
        }

      
        window.generalNetChartInstance = null; 

        function openGeneralDenemeAnalizi() {
            document.getElementById('generalDenemeAnaliziPopup').style.display = 'flex';
        }
        function closeGeneralDenemeAnalizi() {
            document.getElementById('generalDenemeAnaliziPopup').style.display = 'none';
        }

        document.addEventListener("DOMContentLoaded", function () {
            const generalForm = document.getElementById("generalDenemeForm");
            if (generalForm) {
                generalForm.addEventListener("submit", function (e) {
                    e.preventDefault();
                    const dersler = ["Türkçe", "Matematik", "Fen", "Sosyal", "İngilizce"];
                    const netler = [
                        hesaplaNet(generalForm.turkce_d.value, generalForm.turkce_y.value),
                        hesaplaNet(generalForm.mat_d.value, generalForm.mat_y.value),
                        hesaplaNet(generalForm.fen_d.value, generalForm.fen_y.value),
                        hesaplaNet(generalForm.sos_d.value, generalForm.sos_y.value),
                        hesaplaNet(generalForm.ing_d.value, generalForm.ing_y.value)
                    ];
        
                    const ctx = document.getElementById("generalNetChart").getContext("2d"); 
                    if (window.generalNetChartInstance) {
                        window.generalNetChartInstance.destroy();
                    }
                    window.generalNetChartInstance = new Chart(ctx, {
                        type: "pie", 
                        data: {
                            labels: dersler,
                            datasets: [{
                                data: netler.map(n => Math.max(0, n)), 
                                backgroundColor: [
                                    "#f44336", "#2196F3", "#4CAF50", "#FF9800", "#9C27B0"
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'bottom' },
                                title: { display: true, text: 'Genel Deneme Net Dağılımı' }
                            }
                        }
                    });
                });
            }
        
            function hesaplaNet(dogru, yanlis) {
                let d = parseInt(dogru) || 0;
                let y = parseInt(yanlis) || 0;
                
                return parseFloat((d - y * 0.25).toFixed(2));
            }
        });

    </script>
  
</body>
</html>